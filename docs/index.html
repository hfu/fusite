<!DOCTYPE html>
<html lang='ja'>

<head>
    <meta charset="utf-8" />
    <title>fusi - å›½åœŸåœ°ç†é™¢æ¨™é«˜ã‚¿ã‚¤ãƒ«å¯è¦–åŒ–</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="description" content="å›½åœŸåœ°ç†é™¢ã®æ¨™é«˜ãƒ‡ãƒ¼ã‚¿ã‚’ WebP Terrarium ã‚¿ã‚¤ãƒ«ã¨ã—ã¦å¯è¦–åŒ–" />
    
    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@5.6.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@5.6.0/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- PMTiles protocol -->
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
    
    <link href="style.css" rel="stylesheet" />
</head>

<body>
    <div id="map"></div>
    
    <div class="info-panel">
        <h1>fusi æ¨™é«˜ã‚¿ã‚¤ãƒ«</h1>
        <p>å›½åœŸåœ°ç†é™¢ã®æ¨™é«˜ãƒ‡ãƒ¼ã‚¿ã‚’ Terrarium å½¢å¼ã§å¯è¦–åŒ–</p>
        <p class="attribution">
            ãƒ‡ãƒ¼ã‚¿: <a href="https://www.gsi.go.jp/" target="_blank">å›½åœŸåœ°ç†é™¢ (GSI Japan)</a><br>
            æ¸¬é‡æ³•ã«åŸºã¥ãå›½åœŸåœ°ç†é™¢é•·æ‰¿èªï¼ˆä½¿ç”¨ï¼‰R 6JHs 133<br>
            <br>
            Inspired by <a href="https://github.com/mapterhorn/mapterhorn" target="_blank">Mapterhorn</a><br>
            Made with <a href="https://github.com/hfu/fusi" target="_blank">fusi</a>
        </p>
    </div>
    
    <script type="text/javascript">
        // Initialize the map with 3D terrain visualization
        const map = new maplibregl.Map({
            container: 'map',
            hash: 'map',
            zoom: 9,
            center: [138.7292, 35.3628], // Mount Fuji area
            pitch: 60,
            bearing: 0,
            maxPitch: 85,
            projection: 'globe', // Enable globe projection
            style: {
                version: 8,
                glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
                sources: {
                    osm: {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxzoom: 19
                    },
                    fusiTerrain: {
                        type: 'raster-dem',
                        tiles: ['https://tunnel.optgeo.org/martin/fusi/{z}/{x}/{y}'],
                        encoding: 'terrarium',
                        tileSize: 512,
                        minzoom: 0,
                        maxzoom: 16
                    }
                },
                layers: [
                    {
                        id: 'background',
                        type: 'background',
                        paint: {
                            'background-color': '#e0e0e0'
                        }
                    },
                    {
                        id: 'osm',
                        type: 'raster',
                        source: 'osm',
                        paint: {
                            'raster-opacity': 0.7
                        }
                    },
                    {
                        id: 'hillshade',
                        type: 'hillshade',
                        source: 'fusiTerrain',
                        paint: {
                            'hillshade-exaggeration': 0.3,
                            'hillshade-shadow-color': '#473B24'
                        }
                    }
                ],
                terrain: {
                    source: 'fusiTerrain',
                    exaggeration: 1.5
                },
                sky: {
                    'sky-color': '#87CEEB',
                    'sky-horizon-blend': 0.5,
                    'horizon-color': '#ffffff',
                    'horizon-fog-blend': 0.5,
                    'fog-color': '#ffffff',
                    'fog-ground-blend': 0.5
                }
            }
        });

        // Add navigation controls
        map.addControl(new maplibregl.NavigationControl({
            visualizePitch: true,
            showZoom: true,
            showCompass: true
        }), 'top-right');

        // Add scale control
        map.addControl(new maplibregl.ScaleControl({
            maxWidth: 200,
            unit: 'metric'
        }), 'bottom-right');

        // Add fullscreen control
        map.addControl(new maplibregl.FullscreenControl(), 'top-right');

        // Add geolocate control
        map.addControl(new maplibregl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true
        }), 'top-right');

        // Custom Globe Control
        class GlobeControl {
            constructor() {
                this._isGlobeView = true;
            }

            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.className = 'maplibregl-ctrl maplibregl-ctrl-group';
                this._button = document.createElement('button');
                this._button.className = 'maplibregl-ctrl-icon';
                this._button.type = 'button';
                this._button.title = 'Toggle Globe/Mercator';
                this._button.innerHTML = 'ğŸŒ';
                this._button.style.fontSize = '18px';
                this._button.onclick = () => {
                    this._isGlobeView = !this._isGlobeView;
                    map.setProjection(this._isGlobeView ? 'globe' : 'mercator');
                    this._button.innerHTML = this._isGlobeView ? 'ğŸŒ' : 'ğŸ—ºï¸';
                };
                this._container.appendChild(this._button);
                return this._container;
            }

            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }

        // Add Globe control
        map.addControl(new GlobeControl(), 'top-right');

        // Custom Terrain Exaggeration Control
        class TerrainExaggerationControl {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.className = 'maplibregl-ctrl terrain-ctrl';
                this._container.innerHTML = `
                    <div class="terrain-exaggeration">
                        <label for="terrain-slider">åœ°å½¢å¼·èª¿: <span id="terrain-value">1.5</span>x</label>
                        <input type="range" id="terrain-slider" min="0" max="3" step="0.1" value="1.5">
                    </div>
                `;
                
                const slider = this._container.querySelector('#terrain-slider');
                const valueDisplay = this._container.querySelector('#terrain-value');
                
                slider.oninput = (e) => {
                    const value = parseFloat(e.target.value);
                    valueDisplay.textContent = value.toFixed(1);
                    map.setTerrain({
                        source: 'fusiTerrain',
                        exaggeration: value
                    });
                };
                
                return this._container;
            }

            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }

        // Add Terrain Exaggeration control
        map.addControl(new TerrainExaggerationControl(), 'bottom-left');

        // Add attribution link
        map.on('load', () => {
            console.log('Map loaded successfully with fusi terrain tiles');
            
            // Add custom attribution
            const attributionControl = document.querySelector('.maplibregl-ctrl-attrib-inner');
            if (attributionControl && !attributionControl.innerHTML.includes('å›½åœŸåœ°ç†é™¢')) {
                attributionControl.innerHTML += ' | ãƒ‡ãƒ¼ã‚¿: <a href="https://www.gsi.go.jp/" target="_blank">å›½åœŸåœ°ç†é™¢ (GSI Japan)</a> R 6JHs 133';
            }
        });

        // Log terrain tile loading for debugging
        map.on('sourcedataloading', (e) => {
            if (e.sourceId === 'fusiTerrain') {
                console.log('Loading fusi terrain tile:', e);
            }
        });

        map.on('error', (e) => {
            console.error('Map error:', e);
        });
    </script>
</body>

</html>
